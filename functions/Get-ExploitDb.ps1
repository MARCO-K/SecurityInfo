<#
.SYNOPSIS
    Searches for publicly available exploits in the Exploit-DB database for given CVE IDs.

.DESCRIPTION
    This function queries the internal AJAX endpoint of the Exploit-DB website to find exploits associated with one or more CVE IDs.
    It checks for the existence of public proof-of-concept or functional exploit code, which is a key indicator of a vulnerability's practical risk.

.PARAMETER CveId
    An array of one or more CVE IDs (e.g., "2023-12345") to search for. The 'CVE-' prefix is optional. This parameter accepts pipeline input.

.EXAMPLE
    Get-ExploitDb -CveId "2023-12345"
    # Searches for exploits related to CVE-2023-12345.

.EXAMPLE
    "2023-12345", "2022-5678" | Get-ExploitDb
    # Searches for exploits for two different CVEs using pipeline input.

.OUTPUTS
    [pscustomobject]
    Returns a custom object for each found exploit, containing details such as:
    - CVEID
    - ExploitID: The unique ID on Exploit-DB.
    - ExploitLink: A direct URL to the exploit.
    - ExploitTitle: The title of the exploit entry.
    - Platform: The affected platform.
    - PublishedDate: The date the exploit was published.
    - Verified: A boolean indicating if the exploit has been verified.

.LINK
    https://www.exploit-db.com/

.NOTES
    Author: Marco Kleinert
    Date: July 2025
    This function works by mimicking browser AJAX requests to the Exploit-DB search endpoint, as there is no official public API.
    This method may be fragile if the website's structure changes.
    If no exploits are found for a given CVE, the function returns nothing for that CVE.
#>
function Get-ExploitDb {
    [CmdletBinding()]
    param (
        [Parameter(Mandatory = $true, ValueFromPipeline = $true)]
        [string[]]$CveId
    )

    process {
        foreach ($singleCveId in $CveId) {
            if (-not $singleCveId.StartsWith('CVE-', [System.StringComparison]::OrdinalIgnoreCase)) {
                $singleCveId = "CVE-$singleCveId"
            }

            # This URL queries the internal DataTables AJAX endpoint of Exploit-DB
            $ajaxUrl = "https://www.exploit-db.com/search?cve=$singleCveId&draw=2&columns%5B0%5D%5Bdata%5D=date_published&columns%5B0%5D%5Bname%5D=date_published&columns%5B0%5D%5Bsearchable%5D=true&columns%5B0%5D%5Borderable%5D=true&columns%5B0%5D%5Bsearch%5D%5Bvalue%5D=&columns%5B0%5D%5Bsearch%5D%5Bregex%5D=false&columns%5B1%5D%5Bdata%5D=download&columns%5B1%5D%5Bname%5D=download&columns%5B1%5D%5Bsearchable%5D=false&columns%5B1%5D%5Borderable%5D=false&columns%5B1%5D%5Bsearch%5D%5Bvalue%5D=&columns%5B1%5D%5Bsearch%5D%5Bregex%5D=false&columns%5B2%5D%5Bdata%5D=application_md5&columns%5B2%5D%5Bname%5D=application_md5&columns%5B2%5D%5Bsearchable%5D=true&columns%5B2%5D%5Borderable%5D=false&columns%5B2%5D%5Bsearch%5D%5Bvalue%5D=&columns%5B2%5D%5Bsearch%5D%5Bregex%5D=false&columns%5B3%5D%5Bdata%5D=verified&columns%5B3%5D%5Bname%5D=verified&columns%5B3%5D%5Borderable%5D=false&columns%5B3%5D%5Bsearch%5D%5Bvalue%5D=&columns%5B3%5D%5Bsearch%5D%5Bregex%5D=false&columns%5B4%5D%5Bdata%5D=description&columns%5B4%5D%5Bname%5D=description&columns%5B4%5D%5Bsearchable%5D=true&columns%5B4%5D%5Borderable%5D=false&columns%5B4%5D%5Bsearch%5D%5Bvalue%5D=&columns%5B4%5D%5Bsearch%5D%5Bregex%5D=false&columns%5B5%5D%5Bdata%5D=type_id&columns%5B5%5D%5Bname%5D=type_id&columns%5B5%5D%5Bsearchable%5D=true&columns%5B5%5D%5Borderable%5D=false&columns%5B5%5D%5Bsearch%5D%5Bvalue%5D=&columns%5B5%D%5Bsearch%5D%5Bregex%5D=false&columns%5B6%5D%5Bdata%5D=platform_id&columns%5B6%5D%5Bname%5D=platform_id&columns%5B6%5D%5Bsearchable%5D=true&columns%5B6%5D%5Borderable%5D=false&columns%5B6%5D%5Bsearch%5D%5Bvalue%5D=&columns%5B6%5D%5Bsearch%5D%5Bregex%5D=false&columns%5B7%5D%5Bdata%5D=author__id&columns%5B7%5D%5Bname%5D=author_id&columns%5B7%5D%5Bsearchable%5D=false&columns%5B7%5D%5Borderable%5D=false&columns%5B7%5D%5Bsearch%5D%5Bvalue%5D=&columns%5B7%5D%5Bsearch%5D%5Bregex%5D=false&order%5B0%5D%5Bcolumn%5D=0&order%5B0%5D%5Bdir%5D=desc&start=0&length=15&search%5Bvalue%5D=&search%5Bregex%5D=false"

            # Define headers to mimic a browser's AJAX request
            $headers = @{
                "User-Agent"       = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.88 Safari/537.36"
                "Referer"          = "https://www.exploit-db.com/search?cve=$singleCveId"
                "X-Requested-With" = "XMLHttpRequest"
                "Accept"           = "application/json, text/javascript, */*; q=0.01"
            }

            try {
                Write-Verbose "--- Querying Exploit-DB API: $apiUrl ---"

                $OriginalVerbosePreference = $VerbosePreference
                try {
                    $VerbosePreference = 'SilentlyContinue'
                    $apiResponse = Invoke-RestMethod -Method Get -Uri $ajaxUrl -Headers $headers -ErrorAction Stop
                }
                finally {
                    $VerbosePreference = $OriginalVerbosePreference
                }

                if ($apiResponse.data -and $apiResponse.data.Count -gt 0) {
                    foreach ($exploitData in $apiResponse.data) {
                        if ($exploitData.id) {
                            [PSCustomObject]@{
                                CVEID         = $singleCveId
                                ExploitID     = $exploitData.id
                                ExploitLink   = "https://www.exploit-db.com/exploits/$($exploitData.id)"
                                ExploitTitle  = $exploitData.description[1] # The title is the second element of the description array
                                Platform      = $exploitData.platform_id
                                PublishedDate = $exploitData.date_published
                                Verified      = [bool]$exploitData.verified
                            }
                        }
                    }
                }
                else {
                    Write-Verbose "No exploits found on Exploit-DB for CVE $singleCveId."
                }
            }
            catch {
                Write-Error "Failed to retrieve data for CVE $singleCveId from the Exploit-DB AJAX endpoint: $_"
            }
        }
    }
}
